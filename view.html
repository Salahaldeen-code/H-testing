<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phishing Snapshot Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    #snapshots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 10px;
      justify-items: center;
    }
    .snapshot-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #snapshots img {
      max-width: 100%;
      height: auto;
      border: 2px solid #ccc;
    }
    .button-container {
      margin-top: 10px;
    }
    .button-container button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>Captured Snapshots</h2>
  <div id="snapshots"></div>

  <script>
    // SECURITY ISSUE: Token should never be exposed in frontend code
    // Should be moved to backend environment variables
    const DROPBOX_TOKEN = 'sl.u.AFyUN24VALspeJncqt0OxPc1ie9CmNrPujY-8zzS8tcgpKTHXVWGcsf4Fe7WlOB2pvfphpWBap21D493ko9VZezreWDTBjBy27Ix4eJaoXw32CsGLKLuXKZclp_SEs8c3bVNTY8aypT29eWqDGie05UgURh7uTx-Y0BQuq3iPIAisMrHYRff7UosWV5hnz0uPLD9oFZlJAL7SJV-NVK-qGtemRRTYxzp-Rf-F0K_ygU580cTx6Fqf57BI2Ewhzs3t_JM8rVOnJ1hlphPs1-4wwASaQrs0CF5PycEZVPD5RvBdxw8sLFRVVbTIlaydA1SJSavTKnsf5FKEgZTZ98vUizOKd5oAcvvJbaOG9Sf8ZjFEH3fJQYt4EmLbxpWpnxLm5A_5htx6wUe2aNYTT1M84yHgFjFOf0V35AQ2Qlw599Gwe46hBuRgg_WOWZBhwqdL7AKGDUPWKqU-nyauwVe_jJQ65qrDH0Fg7M566NHaiwC09NhyRNqpA4SAH8KzTInRl09f8SsmXaNZZ_zZdaut8XtIoedEruO-9fHcbrnxZXHUnmc65nuP4a_9r2EZ5tQqlBcf5Kn705AiLmQ9EQ1V0VuUulhwxbeeinvwUgCpBd7e7gB2uQixDHCq2UIQ0M_3R0hNyjBVfqOhgsRc5xNMKNHDfN9LXO-0waL214plLRTa5b-TJYH8MKnqZU6kjVQNW7IAi5TzwATlwOtO-Wy4cTuxKuoWQBqoGPni-daWUx_Gkc22tbq0qI1v47-wcjzzsz27hLJ8pcmse5JrR_RcqXYLopWO7k7gWAQ5DtJ0XzZi0ZsVTyF8FJSaKbPIbWkUqGXP-81YYglgKRIIny1QUTqedAeNrStL9PP2Cxh8vqgDwjzGqEliQl_HTmxO-zVetSxjW6y91rEK9jai1_-NQ64mDsQGgHPEFyVIgV8AeIn9wvCU5eJcDnTf8v9Jmo6c2XfzPqAzVyZCU2DxERsHU7_zBYHlB90-8pyAPivjy0M_cKSYry3qSLi9cUbdZpCDQBXXv7RQsc1nQ-1RpdLehDbpfJh4oRm_B051Z9tECEPkyf6Ob4SyKfm-6X5lW7YEY7IxT-6cFCbjQU1j33xVHBxrbipdBLIE6SYm2gMZBAl9IkMlTfdy1U-ULglj6kYEWX-ic6B4RTT9TgVN_dfyFjIPY91tr4x2C_5QN5K1APDw8jlyVbxzWAxRUMR0qWqk7IfM3gzBTNISwFpkNoF1nT94AGxNH0xzHmauCMOFBTjv0_3izqd5eIK_dTMXLPYIf42xbMOlsYW9pGi-OsZNSjkAXeXBU6KHvoXdMG56KQjFzMlDusgYd60ing_I2KXhg6hmdnu3pT83d70JT2XUIRkUXMJwckcHadaQdGZlX6U8TUxKQRUmvagdbG0JaVe13Cxe0H4m8UKqXD5kDXDrqUshF-4P9_oGkbrTkeGY26PjA'; // Never expose this in production!
    const DROPBOX_FOLDER = '/snapshots';
    
    async function listDropboxFiles() {
      const url = 'https://api.dropboxapi.com/2/files/list_folder';
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${DROPBOX_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            path: DROPBOX_FOLDER,
            recursive: false,
            include_media_info: false,
            include_deleted: false
          })
        });

        if (!response.ok) {
          const errorDetails = await response.json();
          console.error("Error listing files:", errorDetails);
          alert("Error: Unable to fetch files from Dropbox. Check the Dropbox token.");
          return;
        }

        return await response.json();
      } catch (error) {
        console.error("Error:", error);
        alert("Error occurred while fetching files from Dropbox.");
      }
    }
    
    async function getTemporaryLink(path) {
      const url = 'https://api.dropboxapi.com/2/files/get_temporary_link';
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${DROPBOX_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path })
        });

        if (!response.ok) {
          const errorDetails = await response.json();
          console.error("Error fetching temporary link:", errorDetails);
          alert("Error: Unable to fetch file. Check the Dropbox token and file path.");
          return;
        }

        const linkData = await response.json();
        return linkData;
      } catch (error) {
        console.error("Error:", error);
        alert("Error occurred while fetching the file.");
      }
    }
    
    async function deleteFile(path) {
      const url = 'https://api.dropboxapi.com/2/files/delete_v2';
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${DROPBOX_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path })
        });

        if (!response.ok) {
          const errorDetails = await response.json();
          console.error("Error deleting file:", errorDetails);
          alert("Error: Unable to delete the file.");
          return;
        }

        return await response.json();
      } catch (error) {
        console.error("Error:", error);
        alert("Error occurred while deleting the file.");
      }
    }
    
    // Load and display images
    async function loadSnapshots() {
      try {
        const files = await listDropboxFiles();
        if (!files || !files.entries) {
          alert("No snapshots found.");
          return;
        }

        const snapshotsContainer = document.getElementById('snapshots');
        snapshotsContainer.innerHTML = '';
    
        for (const entry of files.entries) {
          const linkData = await getTemporaryLink(entry.path_display);
          
          const snapshotDiv = document.createElement('div');
          snapshotDiv.classList.add('snapshot-container');
          
          snapshotDiv.innerHTML = ` 
            <img src="${linkData.link}" alt="Snapshot">
            <div class="button-container">
              <button onclick="downloadSnapshot('${linkData.link}')">‚¨áÔ∏è Download</button>
              <button onclick="deleteSnapshot('${entry.path_display}')">üóëÔ∏è Delete</button>
            </div>
          `;
          
          snapshotsContainer.appendChild(snapshotDiv);
        }
      } catch (error) {
        console.error("Error loading snapshots:", error);
      }
    }
    
    function downloadSnapshot(url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = `snapshot_${Date.now()}.png`;
      a.click();
    }
    
    async function deleteSnapshot(path) {
      if (confirm("Delete this snapshot?")) {
        try {
          await deleteFile(path);
          loadSnapshots(); // Refresh the list
        } catch (error) {
          console.error("Delete failed:", error);
        }
      }
    }
    
    // Initial load
    loadSnapshots();
  </script>
</body>
</html>
